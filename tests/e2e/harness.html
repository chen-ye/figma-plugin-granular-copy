<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Figma Plugin E2E Harness</title>
    <style>
        body { margin: 0; padding: 20px; font-family: sans-serif; }
        iframe { border: 1px solid #ccc; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <h1>Plugin Harness</h1>
    <iframe id="plugin-ui" src="/dist/ui/index.html" width="320" height="400"></iframe>
    <script type="module">
        const worker = new Worker('/dist/e2e/worker.mjs', { type: 'module' });
        const iframe = document.getElementById('plugin-ui');

        // Relay from Worker to UI (Figma -> UI)
        worker.onmessage = (event) => {
            const { type, payload, width, height } = event.data;
            
            console.log('[Worker -> Harness]', type, payload);

            if (type === 'FIGMA_UI_MESSAGE') {
                // pluginMessage is the standard Figma protocol key
                iframe.contentWindow.postMessage({ pluginMessage: payload }, '*');
            } else if (type === 'FIGMA_UI_RESIZE') {
                iframe.width = width;
                iframe.height = height;
            } else if (type === 'FIGMA_SHOW_UI') {
                console.log('Main requested Show UI');
            }
        };

        // Relay from UI to Worker (UI -> Figma)
        window.onmessage = (event) => {
            // Figma UI sends { pluginMessage: ... } to parent
            const { pluginMessage } = event.data;
            if (pluginMessage) {
                console.log('[UI -> Harness]', pluginMessage);
                worker.postMessage({ type: 'UI_TO_MAIN', payload: pluginMessage });
            }
        };

        // Expose worker for tests to trigger commands
        // We'll attach a helper to window to send commands to the worker
        window.sendToWorker = (msg) => worker.postMessage(msg);
    </script>
</body>
</html>
